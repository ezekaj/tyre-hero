<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Emergency Tyre Service - Mobile Optimized</title>

    <!-- Performance optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800;900&display=swap" rel="stylesheet">

    <!-- Critical mobile styles -->
    <link rel="stylesheet" href="mobile-emergency-styles.css">

    <!-- Progressive enhancement styles -->
    <style>
        /* Critical above-the-fold styles for instant loading */
        .emergency-container {
            position: relative;
            z-index: 10;
            padding: env(safe-area-inset-top, 20px) 20px env(safe-area-inset-bottom, 20px);
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: transparent;
        }

        .hero-content {
            width: 100%;
            max-width: 400px;
            text-align: center;
            z-index: 11;
            position: relative;
        }

        .emergency-status {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 2px solid #16A34A;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 16px;
            height: 16px;
            background: #16A34A;
            border-radius: 50%;
            margin-right: 12px;
            animation: statusPulse 2s infinite;
        }

        .status-text {
            font-weight: 800;
            font-size: 18px;
            color: #16A34A;
        }

        .response-time {
            font-size: 14px;
            color: #6B7280;
            font-weight: 600;
        }

        .location-line {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 32px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .location-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        .location-text {
            font-weight: 700;
            font-size: 16px;
            color: #1F2937;
        }

        /* THE MEGA CALL BUTTON - Most critical element */
        .mega-call-button {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            max-width: 350px !important;
            height: 120px !important;
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%) !important;
            color: white !important;
            text-decoration: none !important;
            border-radius: 20px !important;
            box-shadow: 0 12px 40px rgba(220, 38, 38, 0.4) !important;
            font-size: 20px !important;
            font-weight: 800 !important;
            text-align: center !important;
            transition: all 0.2s ease !important;
            position: relative !important;
            z-index: 99999 !important;
            margin: 0 auto 32px auto !important;
            border: 3px solid rgba(255, 255, 255, 0.2) !important;
            animation: emergencyPulse 2s infinite;
        }

        .mega-call-button:active {
            transform: scale(0.98) !important;
        }

        .call-icon {
            font-size: 32px;
            margin-right: 16px;
        }

        .call-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .call-label {
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .phone-number {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 300px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #E5E7EB;
            color: #374151;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 56px;
        }

        .action-btn:hover {
            background: white;
            border-color: #3B82F6;
            color: #3B82F6;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        /* Critical animations */
        @keyframes emergencyPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 12px 40px rgba(220, 38, 38, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 16px 50px rgba(220, 38, 38, 0.6);
            }
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Emergency mode overrides */
        .emergency-mode .mobile-hero-background {
            display: none !important;
        }

        .emergency-mode .emergency-container {
            background: #FFFFFF !important;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .mega-call-button,
            .status-dot {
                animation: none !important;
            }
        }

        /* No-JS fallback */
        .no-js .mobile-hero-background {
            display: none;
        }

        .no-js .emergency-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
    </style>

    <!-- Feature detection script -->
    <script>
        // Feature detection before page load
        (function() {
            // Check JavaScript support
            document.documentElement.classList.remove('no-js');

            // Detect mobile device early
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                             window.innerWidth <= 768;

            if (isMobile) {
                document.documentElement.classList.add('mobile-device');
            }

            // Set initial viewport height for mobile
            function setVH() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }

            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', () => {
                setTimeout(setVH, 100);
            });

            // Emergency mode detection (low battery, slow connection)
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    if (battery.level < 0.15 && !battery.charging) {
                        document.body.classList.add('emergency-mode');
                        console.log('Emergency mode activated: Low battery');
                    }
                });
            }

            // Check connection speed
            if (navigator.connection) {
                const connection = navigator.connection;
                if (['slow-2g', '2g'].includes(connection.effectiveType)) {
                    document.body.classList.add('slow-connection');
                    console.log('Slow connection detected');
                }
            }
        })();
    </script>
</head>

<body class="no-js">
    <!-- Mobile Hero Background Container -->
    <div id="hero-background" class="mobile-hero-background" data-mobile-hero="true">
        <!-- Background will be injected here by JavaScript -->
    </div>

    <!-- Emergency Interface Container -->
    <div class="emergency-container">
        <!-- Emergency Status Display -->
        <div class="emergency-status">
            <div class="status-indicator">
                <span class="status-dot" aria-hidden="true"></span>
                <span class="status-text">EMERGENCY SERVICE AVAILABLE</span>
            </div>
            <div class="response-time">45-60 minute response time</div>
        </div>

        <!-- Location Display -->
        <div class="location-line">
            <span class="location-icon" aria-hidden="true">üìç</span>
            <span class="location-text" id="detectedLocation">Detecting your location...</span>
        </div>

        <!-- Hero Content -->
        <div class="hero-content">
            <!-- MASSIVE Emergency Call Button -->
            <a href="tel:08001234567"
               class="mega-call-button"
               role="button"
               aria-label="Emergency tyre service hotline. Call now for immediate assistance."
               aria-describedby="emergency-description">
                <div class="call-icon" aria-hidden="true">üìû</div>
                <div class="call-content">
                    <div class="call-label">EMERGENCY CALL</div>
                    <div class="phone-number">0800 123 4567</div>
                </div>
            </a>

            <!-- Secondary Actions -->
            <div class="quick-actions">
                <button class="action-btn touch-target"
                        onclick="shareLocation()"
                        aria-label="Share your current location">
                    üìç SHARE MY LOCATION
                </button>
                <button class="action-btn touch-target"
                        onclick="showEmergencyHelp()"
                        aria-label="Show emergency guidance steps">
                    ‚ÑπÔ∏è EMERGENCY STEPS
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden screen reader description -->
    <div id="emergency-description" class="sr-only">
        Emergency tyre service available 24/7. Average response time 45 to 60 minutes.
        This service covers roadside emergencies including flat tyres, punctures, and wheel changes.
    </div>

    <!-- Emergency Help Modal -->
    <div class="emergency-modal" id="emergencyModal" style="display: none;">
        <div class="modal-overlay" onclick="hideEmergencyHelp()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Emergency Steps</h2>
                <button onclick="hideEmergencyHelp()" class="modal-close" aria-label="Close help">‚úï</button>
            </div>
            <div class="modal-body">
                <ol class="emergency-steps">
                    <li>
                        <strong>Stay Safe</strong><br>
                        Move away from traffic to a safe location
                    </li>
                    <li>
                        <strong>Call for Help</strong><br>
                        Tap the red button: <strong>0800 123 4567</strong>
                    </li>
                    <li>
                        <strong>Share Location</strong><br>
                        Tell us exactly where you are
                    </li>
                    <li>
                        <strong>Wait Safely</strong><br>
                        Stay visible and away from traffic
                    </li>
                </ol>
                <div class="emergency-tips">
                    <h3>While You Wait:</h3>
                    <ul>
                        <li>Turn on hazard lights</li>
                        <li>Use warning triangle if available</li>
                        <li>Keep phone charged</li>
                        <li>Stay with your vehicle if safe</li>
                    </ul>
                </div>
                <div class="repeat-call-section">
                    <a href="tel:08001234567" class="repeat-call-btn">
                        üìû CALL EMERGENCY SERVICE
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen reader only text -->
    <div class="sr-only">
        <h1>Emergency Tyre Service - 24/7 Roadside Assistance</h1>
        <p>Professional emergency tyre service available now. Call 0800 123 4567 for immediate assistance.</p>
    </div>

    <!-- Load mobile-optimized hero background -->
    <script src="mobile-hero-background.js"></script>

    <!-- Load emergency UX patterns -->
    <script src="mobile-emergency-ux-patterns.js"></script>

    <!-- Load debug console (only in development) -->
    <script>
        if (window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1') {
            const script = document.createElement('script');
            script.src = 'mobile-debug-console.js';
            document.head.appendChild(script);
        }
    </script>

    <!-- Emergency functionality scripts -->
    <script>
        // Core emergency functionality that must work even if other scripts fail
        let userHasCalledEmergency = false;
        let locationWatchId = null;

        // Track emergency call
        document.addEventListener('click', (e) => {
            if (e.target.closest('[href^="tel:"]')) {
                userHasCalledEmergency = true;

                // Haptic feedback if available
                if ('vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100]);
                }

                // Show post-call guidance after a delay
                setTimeout(() => {
                    showPostCallGuidance();
                }, 2000);

                // Track in analytics (non-blocking)
                try {
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'emergency_call', {
                            'event_category': 'emergency',
                            'event_label': 'mobile_call_button'
                        });
                    }
                } catch (e) {
                    // Analytics failure shouldn't break emergency functionality
                }
            }
        });

        // Location sharing functionality
        function shareLocation() {
            const locationText = document.getElementById('detectedLocation');

            if ('vibrate' in navigator) {
                navigator.vibrate([50, 50, 50]);
            }

            if (!('geolocation' in navigator)) {
                showLocationFallback();
                return;
            }

            // Show loading state
            if (locationText) {
                locationText.textContent = 'Getting location...';
                locationText.style.color = '#F59E0B';
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const locationString = `Emergency Location: ${lat}, ${lng}`;
                    const mapsUrl = `https://maps.google.com/?q=${lat},${lng}`;

                    // Try native sharing first
                    if ('share' in navigator) {
                        navigator.share({
                            title: 'Emergency Tyre Service - My Location',
                            text: locationString,
                            url: mapsUrl
                        }).then(() => {
                            showToast('Location shared successfully!', 'success');
                            updateLocationDisplay(lat, lng);
                        }).catch(() => {
                            copyToClipboard(locationString, mapsUrl);
                        });
                    } else {
                        copyToClipboard(locationString, mapsUrl);
                    }
                },
                (error) => {
                    console.warn('Location error:', error);
                    showLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }

        function copyToClipboard(locationString, mapsUrl) {
            const fullLocation = `${locationString}\n${mapsUrl}`;

            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(fullLocation).then(() => {
                    showToast('Location copied! Paste when calling for help.', 'success');
                }).catch(() => {
                    showLocationFallback();
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = fullLocation;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Location copied! Paste when calling for help.', 'success');
                } catch (err) {
                    document.body.removeChild(textArea);
                    showLocationFallback();
                }
            }
        }

        function showLocationFallback() {
            const manualLocation = prompt(
                'Please describe your location:\n' +
                'For example: "M4 motorway, junction 6, eastbound" or "High Street, near McDonald\'s"'
            );

            if (manualLocation && manualLocation.trim()) {
                showToast('Location noted! Tell this to emergency service when you call.', 'info');

                const locationText = document.getElementById('detectedLocation');
                if (locationText) {
                    locationText.textContent = manualLocation.trim();
                    locationText.style.color = '#16A34A';
                }
            }
        }

        function showLocationError(error) {
            let message = 'Location not available. ';

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Please allow location access and try again.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'GPS signal not available.';
                    break;
                case error.TIMEOUT:
                    message += 'Location request timed out.';
                    break;
                default:
                    message += 'Unknown location error.';
                    break;
            }

            showToast(message, 'error');

            const locationText = document.getElementById('detectedLocation');
            if (locationText) {
                locationText.textContent = 'Tap to enter location manually';
                locationText.style.color = '#DC2626';
                locationText.style.cursor = 'pointer';
                locationText.onclick = showLocationFallback;
            }
        }

        function updateLocationDisplay(lat, lng) {
            const locationText = document.getElementById('detectedLocation');
            if (!locationText) return;

            // Try reverse geocoding for user-friendly address
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`)
                .then(response => response.json())
                .then(data => {
                    const address = data.locality || data.city || data.principalSubdivision || `${lat}, ${lng}`;
                    locationText.textContent = address;
                    locationText.style.color = '#16A34A';
                })
                .catch(() => {
                    locationText.textContent = `${lat}, ${lng}`;
                    locationText.style.color = '#16A34A';
                });
        }

        // Emergency help modal
        function showEmergencyHelp() {
            const modal = document.getElementById('emergencyModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 10);

                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            }
        }

        function hideEmergencyHelp() {
            const modal = document.getElementById('emergencyModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        function showPostCallGuidance() {
            if (userHasCalledEmergency) {
                showToast('‚úì Call made! Help is on the way. Stay safe and keep phone nearby.', 'success');

                // Remove pulsing animation from call button
                const callButton = document.querySelector('.mega-call-button');
                if (callButton) {
                    callButton.style.animation = 'none';
                    callButton.style.background = 'linear-gradient(135deg, #16A34A 0%, #15803D 100%)';
                }
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `emergency-toast toast-${type}`;
            toast.textContent = message;

            const colors = {
                success: '#16A34A',
                error: '#DC2626',
                warning: '#F59E0B',
                info: '#3B82F6'
            };

            toast.style.cssText = `
                position: fixed;
                bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
                left: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                z-index: 999999;
                font-size: 16px;
                font-weight: 600;
                text-align: center;
                transform: translateY(100px);
                opacity: 0;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            `;

            document.body.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            });

            // Auto-remove
            setTimeout(() => {
                toast.style.transform = 'translateY(100px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);

            // Haptic feedback
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        // Auto-detect location on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Attempt automatic location detection
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        updateLocationDisplay(
                            position.coords.latitude.toFixed(6),
                            position.coords.longitude.toFixed(6)
                        );
                    },
                    () => {
                        // Silent fail for auto-detection
                        const locationText = document.getElementById('detectedLocation');
                        if (locationText) {
                            locationText.textContent = 'Tap to share location';
                            locationText.style.cursor = 'pointer';
                            locationText.onclick = shareLocation;
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            }
        });

        // Keyboard shortcuts for accessibility
        document.addEventListener('keydown', (e) => {
            // Spacebar or Enter to call emergency number
            if ((e.code === 'Space' || e.code === 'Enter') && !e.target.matches('input, textarea, button')) {
                e.preventDefault();
                const callButton = document.querySelector('.mega-call-button');
                if (callButton) {
                    callButton.click();
                }
            }

            // Alt+L for location sharing
            if (e.altKey && e.code === 'KeyL') {
                e.preventDefault();
                shareLocation();
            }

            // Escape to close modal
            if (e.code === 'Escape') {
                hideEmergencyHelp();
            }
        });

        // Handle visibility changes (background/foreground)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && userHasCalledEmergency) {
                // User returned to page after calling
                showToast('Remember: Help is on the way! Expected arrival: 45-60 minutes.', 'info');
            }
        });
    </script>

    <!-- Emergency modal styles -->
    <style>
        .emergency-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: opacity 0.3s ease;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 20px;
            padding: 24px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #E5E7EB;
        }

        .modal-header h2 {
            color: #DC2626;
            font-size: 22px;
            font-weight: 800;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9CA3AF;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .emergency-steps {
            margin-bottom: 24px;
            padding-left: 20px;
        }

        .emergency-steps li {
            margin-bottom: 16px;
            line-height: 1.5;
            font-size: 16px;
        }

        .emergency-steps strong {
            color: #DC2626;
            font-weight: 800;
        }

        .emergency-tips {
            background: #F3F4F6;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .emergency-tips h3 {
            color: #1F2937;
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 12px 0;
        }

        .emergency-tips ul {
            margin: 0;
            padding-left: 20px;
        }

        .emergency-tips li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #4B5563;
        }

        .repeat-call-section {
            text-align: center;
        }

        .repeat-call-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
            color: white;
            text-decoration: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            transition: all 0.2s ease;
        }

        .repeat-call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .modal-content {
                border: 3px solid #000;
            }

            .mega-call-button {
                border: 3px solid #fff !important;
            }
        }
    </style>
</body>
</html>